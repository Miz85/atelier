---
phase: 03-agent-integration
plan: 04
type: execute
wave: 3
depends_on: ["03-01", "03-02", "03-03"]
files_modified:
  - src/components/AgentView.tsx
  - src/components/CreateWorkspace.tsx
  - src/app.tsx
autonomous: true

must_haves:
  truths:
    - "User can spawn agent when creating workspace"
    - "User can override default agent when creating workspace"
    - "User can view agent output in real-time"
    - "User can stop and restart agents"
  artifacts:
    - path: "src/components/AgentView.tsx"
      provides: "Combined view with output and controls"
      exports: ["AgentView"]
    - path: "src/components/CreateWorkspace.tsx"
      provides: "Agent override option in workspace creation"
      contains: "agentType.*override"
    - path: "src/app.tsx"
      provides: "AgentView integration in main app"
      contains: "AgentView"
  key_links:
    - from: "src/components/AgentView.tsx"
      to: "src/agents/spawn.ts"
      via: "spawnAgent import"
      pattern: "import.*spawnAgent.*from.*spawn"
    - from: "src/components/AgentView.tsx"
      to: "src/state/agents.ts"
      via: "useAtom for agent state"
      pattern: "useAtom.*agent"
    - from: "src/app.tsx"
      to: "src/components/AgentView.tsx"
      via: "AgentView import and render"
      pattern: "import.*AgentView"
---

<objective>
Integrate agent components into the app, add agent override to workspace creation, and wire everything together for full agent lifecycle management.

Purpose: This completes Phase 3 by connecting all agent functionality to the UI.
Output: Working agent integration - user can create workspaces with agents, view output, stop/restart
</objective>

<execution_context>
@/Users/nazim.saouli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nazim.saouli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-agent-integration/03-RESEARCH.md

# Components from this phase
@src/agents/spawn.ts
@src/agents/types.ts
@src/state/agents.ts
@src/components/AgentOutput.tsx
@src/components/AgentControls.tsx

# Existing components to modify
@src/components/CreateWorkspace.tsx
@src/app.tsx
@src/state/workspace.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AgentView component</name>
  <files>src/components/AgentView.tsx</files>
  <action>
Create src/components/AgentView.tsx that combines output display and controls:

1. Imports:
   - React, useState, useEffect, useCallback
   - Box, Text, useInput from 'ink'
   - useAtom, useSetAtom from 'jotai'
   - AgentOutput from './AgentOutput.js'
   - AgentControls from './AgentControls.js'
   - spawnAgent, stopAgent, sendInput, getAgentByWorkspace from '../agents/spawn.js'
   - agentStateByWorkspaceAtom, appendOutputAtom, setStatusAtom, initAgentStateAtom from '../state/agents.js'
   - Workspace from '../state/workspace.js'

2. Props interface:
   ```typescript
   interface AgentViewProps {
     workspace: Workspace;              // Current workspace
     onBack: () => void;               // Go back to main screen
   }
   ```

3. State management:
   - Get agent state for this workspace from agentStateByWorkspaceAtom
   - Use action atoms for updating state

4. Agent spawn handler:
   ```typescript
   const handleStartAgent = useCallback(() => {
     // Clear any previous output
     clearOutput(workspace.id);

     // Spawn agent with callbacks that update Jotai state
     const instance = spawnAgent(
       workspace.id,
       workspace.path,
       workspace.agent,  // Use workspace's configured agent type
       {
         onData: (data) => {
           appendOutput({ workspaceId: workspace.id, output: data });
         },
         onExit: (exitCode, signal) => {
           setStatus({
             workspaceId: workspace.id,
             status: exitCode === 0 ? 'stopped' : 'error',
             error: exitCode !== 0 ? `Exited with code ${exitCode}` : undefined
           });
         },
       }
     );

     // Initialize state with new agent
     initState({ workspaceId: workspace.id, agentId: instance.id });
   }, [workspace]);
   ```

5. Handle restart:
   ```typescript
   const handleRestart = useCallback(() => {
     // handleStartAgent will spawn a new agent
     // The old one was stopped by AgentControls
     handleStartAgent();
   }, [handleStartAgent]);
   ```

6. Handle input (for sending to agent):
   - Track whether input mode is active
   - When user presses 'i', enter input mode
   - In input mode, capture text and send to agent on Enter
   - Press Escape to exit input mode

7. Keyboard shortcuts (when not in input mode):
   - 'i': Enter input mode
   - 'Escape' or 'q': Go back
   - Other keys handled by AgentControls

8. Layout:
   ```tsx
   return (
     <Box flexDirection="column" padding={1}>
       <Box marginBottom={1}>
         <Text bold color="cyan">Agent: {workspace.name}</Text>
         <Text color="gray"> ({workspace.agent})</Text>
       </Box>

       <AgentOutput outputLines={agentState.outputLines} maxVisibleLines={15} />

       <Box marginTop={1}>
         <AgentControls
           agentId={agentState.agentId}
           status={agentState.status}
           workspaceId={workspace.id}
           workspacePath={workspace.path}
           agentType={workspace.agent}
           onStart={handleStartAgent}
           onStop={() => setStatus({ workspaceId: workspace.id, status: 'stopped' })}
           onRestart={handleRestart}
           onError={(err) => setStatus({
             workspaceId: workspace.id,
             status: 'error',
             error: err.message
           })}
         />
       </Box>

       {inputMode ? (
         <Box marginTop={1}>
           <Text color="green">Input: </Text>
           <TextInput value={inputText} onChange={setInputText} onSubmit={handleSendInput} />
         </Box>
       ) : (
         <Box marginTop={1}>
           <Text color="gray">i: input | q: back</Text>
         </Box>
       )}
     </Box>
   );
   ```

9. Export AgentView component
  </action>
  <verify>npx tsc --noEmit (no type errors)</verify>
  <done>AgentView.tsx combines output, controls, and input handling</done>
</task>

<task type="auto">
  <name>Task 2: Add agent override to CreateWorkspace</name>
  <files>src/components/CreateWorkspace.tsx</files>
  <action>
Modify src/components/CreateWorkspace.tsx to allow agent type override:

1. Add state for agent override:
   ```typescript
   const [agentOverride, setAgentOverride] = useState<'claude' | 'opencode' | null>(null);
   ```

2. Add a step in the form flow (or a toggle):
   - After branch name input, show agent selection
   - Default: "Use default ({settings.defaultAgent})"
   - Options: "claude", "opencode", "default"

3. Update the workspace creation call:
   - Pass the selected agent type (override or default from settings)
   ```typescript
   const workspace = await createWorkspace({
     repoPath,
     branchName,
     name: workspaceName || branchName,
     agent: agentOverride ?? settings.defaultAgent,  // AGENT-07: Override support
   });
   ```

4. UI for agent selection:
   - Can be a simple toggle with Tab key
   - Or j/k to cycle through options
   - Show current selection clearly

5. The UI should show:
   ```
   Agent: [claude] opencode (default: claude)
   ```
   Where [claude] indicates current selection

Note: Keep existing form flow - add agent selection as additional step or inline option
  </action>
  <verify>npx tsc --noEmit (no type errors)</verify>
  <done>CreateWorkspace.tsx allows agent type override (AGENT-07)</done>
</task>

<task type="auto">
  <name>Task 3: Wire AgentView into app</name>
  <files>src/app.tsx</files>
  <action>
Modify src/app.tsx to integrate AgentView:

1. Add new Screen type: 'agent-view'
   ```typescript
   type Screen = 'main' | 'settings' | 'create-workspace' | 'workspace-list' | 'agent-view';
   ```

2. Import AgentView component:
   ```typescript
   import { AgentView } from './components/AgentView.js';
   ```

3. Add keyboard shortcut on main screen:
   - 'a': Open agent view for active workspace (if one is active)

4. Handle agent-view screen:
   ```tsx
   if (screen === 'agent-view') {
     if (!activeWorkspace) {
       // Should not happen, but handle gracefully
       setScreen('main');
       return null;
     }
     return <AgentView workspace={activeWorkspace} onBack={() => setScreen('main')} />;
   }
   ```

5. Update keyboard input handler:
   ```typescript
   useInput((input, key) => {
     if (screen !== 'main') return;

     if (input === 'a' && activeWorkspace) {
       setScreen('agent-view');
     }
     // ... existing shortcuts
   });
   ```

6. Update main screen help text:
   ```tsx
   <Text color="gray">
     n: new workspace | w: list workspaces | s: settings
     {activeWorkspace && ' | a: agent view'}
     {' '}| q: quit
   </Text>
   ```

7. Consider auto-opening agent view after workspace creation:
   - When CreateWorkspace succeeds, set screen to 'agent-view'
   - This gives immediate feedback after creating workspace
  </action>
  <verify>npm run build && npm start (should show main screen with 'a' shortcut when workspace active)</verify>
  <done>App integrates AgentView with keyboard navigation</done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build`
2. Create workspace shows agent selection option
3. Main screen shows 'a: agent view' when workspace is active
4. Agent view displays output area and controls
5. Stop/restart controls respond to keyboard
</verification>

<success_criteria>
- User can create workspace with agent override (AGENT-07)
- User can access agent view from main screen
- User can see streaming output (AGENT-02)
- User can stop running agent (AGENT-04)
- User can restart stopped agent (AGENT-05)
- User can send input to agent (AGENT-03)
- All keyboard shortcuts work correctly
- Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-integration/03-04-SUMMARY.md`
</output>
