---
phase: 02-workspace-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/state/workspace.ts
autonomous: true

must_haves:
  truths:
    - "Active workspace ID persists across restarts"
    - "Active workspace atom returns workspace object or null"
    - "Changing active workspace updates immediately via Jotai"
  artifacts:
    - path: "src/state/workspace.ts"
      provides: "Active workspace state atoms"
      exports: ["activeWorkspaceIdAtom", "activeWorkspaceAtom", "setActiveWorkspace"]
  key_links:
    - from: "activeWorkspaceAtom"
      to: "workspacesAtom"
      via: "derived atom lookup"
      pattern: "atom\\(.*get\\(workspacesAtom\\)"
---

<objective>
Extend workspace state with active workspace tracking.

Purpose: Users need to select and switch between workspaces. The active workspace determines which workspace is displayed and receives input.

Output: Extended `src/state/workspace.ts` with activeWorkspaceIdAtom and derived activeWorkspaceAtom
</objective>

<execution_context>
@/Users/nazim.saouli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nazim.saouli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@src/state/workspace.ts
@src/config/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add active workspace atoms to workspace.ts</name>
  <files>src/state/workspace.ts</files>
  <action>
Extend `src/state/workspace.ts` with active workspace tracking:

**Add imports:**
```typescript
import { atom } from 'jotai';
```

**Add activeWorkspaceIdAtom (persisted):**
```typescript
/**
 * Persisted atom for the currently active workspace ID.
 * null means no workspace is active.
 * Persists to ~/.equipe/state/activeWorkspaceId.json
 */
export const activeWorkspaceIdAtom = atomWithStorage<string | null>(
  'activeWorkspaceId',
  null,
  createJotaiStorage<string | null>(),
  { getOnInit: true }
);
```

**Add activeWorkspaceAtom (derived, read-only):**
```typescript
/**
 * Derived atom that returns the full Workspace object for the active workspace.
 * Returns null if no workspace is active or if the active ID doesn't match any workspace.
 */
export const activeWorkspaceAtom = atom((get) => {
  const workspaces = get(workspacesAtom);
  const activeId = get(activeWorkspaceIdAtom);

  if (!activeId) return null;

  return workspaces.find(w => w.id === activeId) ?? null;
});
```

**Add convenience setter function:**
```typescript
/**
 * Helper to set active workspace by ID.
 * Use this from components: setActiveWorkspace(set, workspaceId)
 */
export function setActiveWorkspace(
  set: (atom: typeof activeWorkspaceIdAtom, value: string | null) => void,
  workspaceId: string | null
): void {
  set(activeWorkspaceIdAtom, workspaceId);
}
```

Keep existing Workspace interface and workspacesAtom unchanged.
  </action>
  <verify>
`npm run build` succeeds with no TypeScript errors.
Inspect `src/state/workspace.ts` - should export activeWorkspaceIdAtom, activeWorkspaceAtom.
  </verify>
  <done>
workspace.ts exports:
- Workspace (interface) - unchanged
- workspacesAtom - unchanged
- activeWorkspaceIdAtom (persisted string | null)
- activeWorkspaceAtom (derived Workspace | null)
- setActiveWorkspace (helper function)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test script for active workspace</name>
  <files>src/state/test-state.ts</files>
  <action>
Update `src/state/test-state.ts` to test active workspace atoms:

Add test section after existing workspace tests:

```typescript
// Test active workspace
console.log('\n--- Testing Active Workspace ---');

// Import active workspace atoms
import { activeWorkspaceIdAtom, activeWorkspaceAtom } from './workspace.js';
import { createStore } from 'jotai';

// Create a store for testing
const store = createStore();

// Test 1: Initial state should be null
const initialActiveId = store.get(activeWorkspaceIdAtom);
console.log('Initial active ID:', initialActiveId);
if (initialActiveId !== null) {
  console.log('Note: Active ID already set from previous test run');
}

// Test 2: Set active workspace ID
const testWorkspaceId = 'test-ws-123';
store.set(activeWorkspaceIdAtom, testWorkspaceId);
const activeId = store.get(activeWorkspaceIdAtom);
console.log('After set, active ID:', activeId);
if (activeId !== testWorkspaceId) {
  throw new Error('Active workspace ID not set correctly');
}

// Test 3: Active workspace atom returns null when no matching workspace
const activeWs = store.get(activeWorkspaceAtom);
console.log('Active workspace (no match):', activeWs);
if (activeWs !== null) {
  throw new Error('Expected null when no matching workspace');
}

// Test 4: Active workspace atom returns workspace when ID matches
// First add a workspace to workspacesAtom
const testWorkspace = {
  id: testWorkspaceId,
  name: 'Test Workspace',
  path: '/tmp/test-workspace',
  branch: 'feature/test',
  agent: 'claude' as const,
  createdAt: new Date().toISOString(),
  lastActiveAt: new Date().toISOString(),
};
store.set(workspacesAtom, [testWorkspace]);
const activeWs2 = store.get(activeWorkspaceAtom);
console.log('Active workspace (with match):', activeWs2?.name);
if (activeWs2?.id !== testWorkspaceId) {
  throw new Error('Active workspace should match');
}

// Test 5: Clear active workspace
store.set(activeWorkspaceIdAtom, null);
const clearedId = store.get(activeWorkspaceIdAtom);
if (clearedId !== null) {
  throw new Error('Active workspace should be cleared');
}

console.log('âœ“ Active workspace tests passed');
```

Note: The test uses Jotai's createStore() for isolated testing without React.
  </action>
  <verify>
`npm run build && npm run test:state` passes including new active workspace tests.
Output shows "Active workspace tests passed".
  </verify>
  <done>
test-state.ts verifies:
- Initial active ID is null (or previously set value)
- Setting active workspace ID works
- Derived activeWorkspaceAtom returns null when no match
- Derived activeWorkspaceAtom returns workspace when ID matches
- Clearing active workspace works
  </done>
</task>

</tasks>

<verification>
1. `npm run build` compiles without errors
2. `npm run test:state` passes all tests including active workspace
3. `src/state/workspace.ts` exports new atoms
</verification>

<success_criteria>
- activeWorkspaceIdAtom persists selected workspace ID
- activeWorkspaceAtom derives full workspace object from ID
- Tests verify atoms work correctly with Jotai store
</success_criteria>

<output>
After completion, create `.planning/phases/02-workspace-management/02-02-SUMMARY.md`
</output>
