---
phase: 02-workspace-management
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app.tsx
  - src/workspace/workspace-manager.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Git worktree state stays synchronized with app state on startup"
    - "Orphaned workspaces (deleted outside app) are removed from state"
    - "External worktrees (created outside app) appear in workspace list"
  artifacts:
    - path: "src/app.tsx"
      provides: "useEffect hook that calls sync on repoPath change"
      contains: "useEffect"
    - path: "src/workspace/workspace-manager.ts"
      provides: "gitWorktreeToWorkspace conversion helper"
      exports: ["gitWorktreeToWorkspace"]
  key_links:
    - from: "src/app.tsx"
      to: "syncWorkspacesFromGit"
      via: "useEffect calling sync when repoPath changes"
      pattern: "syncWorkspacesFromGit"
    - from: "src/app.tsx"
      to: "workspacesAtom"
      via: "setWorkspaces with merged sync results"
      pattern: "setWorkspaces"
---

<objective>
Wire syncWorkspacesFromGit into app lifecycle to close the verification gap.

Purpose: The sync function exists and is tested, but is never called. This plan wires it into the app so git worktree state stays synchronized with app state on startup and when repoPath changes.

Output: App automatically syncs workspaces from git worktrees when repoPath is set or changes.
</objective>

<execution_context>
@/Users/nazim.saouli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nazim.saouli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/02-workspace-management/02-VERIFICATION.md
@src/workspace/workspace-manager.ts
@src/app.tsx
@src/state/workspace.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add gitWorktreeToWorkspace conversion helper</name>
  <files>src/workspace/workspace-manager.ts</files>
  <action>
Add a helper function to convert GitWorktree to Workspace:

```typescript
import { nanoid } from 'nanoid';
import type { Settings } from '../state/settings.js';

/**
 * Convert a GitWorktree to a Workspace object.
 * Used when syncing worktrees created outside the app.
 *
 * @param worktree - GitWorktree from git worktree list
 * @param settings - App settings (for default agent)
 */
export function gitWorktreeToWorkspace(
  worktree: GitWorktree,
  settings: Settings
): Workspace {
  // Extract branch name from refs/heads/feature format
  const branchName = worktree.branch
    ? worktree.branch.replace('refs/heads/', '')
    : 'detached';

  // Derive name from branch (use last segment for feature/xyz style)
  const nameParts = branchName.split('/');
  const name = nameParts[nameParts.length - 1];

  const now = new Date().toISOString();

  return {
    id: nanoid(),
    name,
    path: worktree.path,
    branch: branchName,
    agent: settings.defaultAgent,
    pid: undefined,
    createdAt: now,
    lastActiveAt: now,
  };
}
```

Import Settings type from '../state/settings.js'. Export the function in the module.
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit`
Confirm function is exported: `grep -n "export function gitWorktreeToWorkspace" src/workspace/workspace-manager.ts`
  </verify>
  <done>
gitWorktreeToWorkspace function exists and is exported from workspace-manager.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire sync into app lifecycle</name>
  <files>src/app.tsx</files>
  <action>
Add useEffect to AppContent that calls syncWorkspacesFromGit when repoPath is set:

1. Import at top:
```typescript
import { useEffect } from 'react';
import { syncWorkspacesFromGit, gitWorktreeToWorkspace } from './workspace/workspace-manager.js';
```

2. In AppContent, get setWorkspaces:
```typescript
const [workspaces, setWorkspaces] = useAtom(workspacesAtom);
```

3. Add useEffect after the useInput hook:
```typescript
// Sync workspaces from git worktrees when repoPath is set or changes
useEffect(() => {
  if (!repoPath) return;

  const doSync = async () => {
    try {
      const result = await syncWorkspacesFromGit(repoPath, workspaces);

      // Only update if there are changes
      if (result.toAdd.length > 0 || result.toRemove.length > 0) {
        // Convert GitWorktrees to Workspaces
        const newWorkspaces = result.toAdd.map(gw =>
          gitWorktreeToWorkspace(gw, settings)
        );

        // Merge: keep unchanged, add new, remove orphaned
        const toRemoveIds = new Set(result.toRemove.map(w => w.id));
        const merged = [
          ...result.unchanged,
          ...newWorkspaces,
        ].filter(w => !toRemoveIds.has(w.id));

        setWorkspaces(merged);

        // Log for debugging (remove later or make conditional)
        if (result.toAdd.length > 0) {
          console.log(`[equipe] Synced ${result.toAdd.length} external worktree(s)`);
        }
        if (result.toRemove.length > 0) {
          console.log(`[equipe] Removed ${result.toRemove.length} orphaned workspace(s)`);
        }
      }
    } catch (err) {
      console.error('[equipe] Failed to sync workspaces:', err);
    }
  };

  doSync();
  // Only re-run when repoPath changes, not on every workspaces change
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [repoPath]);
```

Note: The eslint-disable is intentional - we only want to sync on repoPath change, not every time workspaces changes (which would cause infinite loop).
  </action>
  <verify>
Run TypeScript check: `npx tsc --noEmit`
Run app: `npm run dev` - should start without errors
  </verify>
  <done>
App calls syncWorkspacesFromGit on startup when repoPath is set. Sync results are applied to workspacesAtom.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test sync behavior</name>
  <files>None (manual verification via test script)</files>
  <action>
Create a test scenario to verify sync works:

1. Start the app with `npm run dev`
2. Set a repo path (via settings or create-workspace flow)
3. Create a workspace through the app (confirms baseline)
4. Exit app
5. Manually create a git worktree via CLI:
   ```bash
   cd /path/to/repo
   git worktree add -b manual-test ../repo-manual-test
   ```
6. Restart app with `npm run dev`
7. Check workspace list - should show the manually created worktree
8. Clean up: delete the manual worktree via app

Alternative automated test approach - extend test-workspace-manager.ts:
```typescript
// After existing tests, add:
console.log('\nTest 4: gitWorktreeToWorkspace');
import { gitWorktreeToWorkspace } from './workspace-manager.js';

const mockWorktree: GitWorktree = {
  path: '/test/path',
  head: 'abc123',
  branch: 'refs/heads/feature/test',
  bare: false,
  detached: false,
  locked: false,
  prunable: false,
};

const mockSettings = { defaultAgent: 'claude' as const, ideCommand: 'code' };
const converted = gitWorktreeToWorkspace(mockWorktree, mockSettings);

if (converted.branch !== 'feature/test') throw new Error('Wrong branch');
if (converted.name !== 'test') throw new Error('Wrong name');
if (converted.agent !== 'claude') throw new Error('Wrong agent');
console.log('Converted workspace:', converted);
console.log('ok gitWorktreeToWorkspace works');
```

Run: `npx tsx src/workspace/test-workspace-manager.ts`
  </action>
  <verify>
Test script passes: `npx tsx src/workspace/test-workspace-manager.ts`
  </verify>
  <done>
Sync behavior verified - external worktrees appear in app state after restart
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. App starts without errors: `npm run dev`
3. Test script passes: `npx tsx src/workspace/test-workspace-manager.ts`
4. Manual verification: worktrees created via git CLI appear in app after restart
</verification>

<success_criteria>
- syncWorkspacesFromGit is called on app startup when repoPath is set
- External worktrees (created via git CLI) appear in workspace list after app restart
- Orphaned workspaces (worktrees deleted outside app) are removed from state
- No infinite loops or duplicate syncs
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-workspace-management/02-06-SUMMARY.md`
</output>
