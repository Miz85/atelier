---
phase: 01-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-01", "01-02", "01-03"]
files_modified:
  - src/app.tsx
  - src/index.ts
  - src/components/Settings.tsx
autonomous: false

must_haves:
  truths:
    - "App launches with Ink and renders UI"
    - "Settings screen allows editing IDE command and default agent"
    - "Cleanup runs on app exit (signal handlers active)"
    - "State persists when app closes and reopens"
  artifacts:
    - path: "src/app.tsx"
      provides: "Root Ink application"
      exports: ["App"]
    - path: "src/index.ts"
      provides: "Entry point"
      contains: "render"
    - path: "src/components/Settings.tsx"
      provides: "Settings UI component"
      exports: ["Settings"]
  key_links:
    - from: "src/index.ts"
      to: "src/processes/lifecycle.ts"
      via: "calls setupGracefulShutdown before render"
      pattern: "setupGracefulShutdown"
    - from: "src/app.tsx"
      to: "src/state/settings.ts"
      via: "uses settingsAtom"
      pattern: "useAtom.*settingsAtom"
    - from: "src/app.tsx"
      to: "jotai"
      via: "Provider wraps app"
      pattern: "Provider"
---

<objective>
Create the Ink application shell with settings UI, wiring together configuration, state, and lifecycle management.

Purpose: Integrates all foundation components into working application that satisfies all Phase 1 success criteria.
Output: Runnable TUI application with settings management.
</objective>

<execution_context>
@/Users/nazim.saouli/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nazim.saouli/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Settings component</name>
  <files>src/components/Settings.tsx</files>
  <action>
Create settings screen component that allows editing IDE command and default agent.

```tsx
// src/components/Settings.tsx
import React, { useState } from 'react';
import { Box, Text, useInput } from 'ink';
import TextInput from 'ink-text-input';
import { useAtom } from 'jotai';
import { settingsAtom } from '../state/settings.js';

interface SettingsProps {
  onBack?: () => void;
}

type Field = 'ideCommand' | 'defaultAgent';

export function Settings({ onBack }: SettingsProps) {
  const [settings, setSettings] = useAtom(settingsAtom);
  const [activeField, setActiveField] = useState<Field>('ideCommand');
  const [editing, setEditing] = useState(false);
  const [editValue, setEditValue] = useState('');

  useInput((input, key) => {
    if (editing) {
      if (key.escape) {
        setEditing(false);
        setEditValue('');
      }
      return;
    }

    // Navigation
    if (key.upArrow || input === 'k') {
      setActiveField('ideCommand');
    }
    if (key.downArrow || input === 'j') {
      setActiveField('defaultAgent');
    }

    // Edit
    if (key.return || input === 'e') {
      if (activeField === 'ideCommand') {
        setEditValue(settings.ideCommand);
        setEditing(true);
      } else if (activeField === 'defaultAgent') {
        // Toggle between agents instead of text input
        const newAgent = settings.defaultAgent === 'claude' ? 'opencode' : 'claude';
        setSettings({ ...settings, defaultAgent: newAgent });
      }
    }

    // Back
    if (input === 'q' || key.escape) {
      onBack?.();
    }
  });

  const handleIdeCommandSubmit = (value: string) => {
    if (value.trim()) {
      setSettings({ ...settings, ideCommand: value.trim() });
    }
    setEditing(false);
    setEditValue('');
  };

  const renderField = (field: Field, label: string, value: string, hint?: string) => {
    const isActive = activeField === field;
    const isEditing = editing && isActive;

    return (
      <Box flexDirection="row" marginBottom={1}>
        <Text color={isActive ? 'cyan' : 'white'}>
          {isActive ? '> ' : '  '}
        </Text>
        <Text bold>{label}: </Text>
        {isEditing ? (
          <TextInput
            value={editValue}
            onChange={setEditValue}
            onSubmit={handleIdeCommandSubmit}
          />
        ) : (
          <Text color="green">{value}</Text>
        )}
        {hint && !isEditing && (
          <Text color="gray"> ({hint})</Text>
        )}
      </Box>
    );
  };

  return (
    <Box flexDirection="column" padding={1}>
      <Box marginBottom={1}>
        <Text bold underline>Settings</Text>
      </Box>

      {renderField('ideCommand', 'IDE Command', settings.ideCommand, 'Enter to edit')}
      {renderField('defaultAgent', 'Default Agent', settings.defaultAgent, 'Enter to toggle')}

      <Box marginTop={2} flexDirection="column">
        <Text color="gray">Navigation: j/k or arrows</Text>
        <Text color="gray">Edit: Enter | Back: q or Esc</Text>
      </Box>
    </Box>
  );
}
```

Install ink-text-input: `npm install ink-text-input`
  </action>
  <verify>
Run `npm run build` - should compile without errors.
  </verify>
  <done>
Settings component renders IDE command and default agent fields.
Supports navigation with j/k or arrows.
IDE command editable with text input.
Default agent toggles between claude and opencode.
Changes persist via settingsAtom.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create App shell and entry point</name>
  <files>src/app.tsx, src/index.ts</files>
  <action>
Create root app component with Jotai provider:

```tsx
// src/app.tsx
import React, { useState, useEffect } from 'react';
import { Box, Text, useApp, useInput } from 'ink';
import { Provider, useAtom } from 'jotai';
import { Settings } from './components/Settings.js';
import { workspacesAtom } from './state/workspace.js';
import { settingsAtom } from './state/settings.js';

type Screen = 'main' | 'settings';

function AppContent() {
  const { exit } = useApp();
  const [screen, setScreen] = useState<Screen>('main');
  const [workspaces] = useAtom(workspacesAtom);
  const [settings] = useAtom(settingsAtom);

  useInput((input, key) => {
    if (screen !== 'main') return;

    // Global shortcuts
    if (input === 's') {
      setScreen('settings');
    }
    if (input === 'q' || (key.ctrl && input === 'c')) {
      exit();
    }
  });

  if (screen === 'settings') {
    return <Settings onBack={() => setScreen('main')} />;
  }

  // Main screen
  return (
    <Box flexDirection="column" padding={1}>
      <Box marginBottom={1}>
        <Text bold color="cyan">equipe</Text>
        <Text color="gray"> - Coding Agent Workspace Manager</Text>
      </Box>

      <Box marginBottom={1} flexDirection="column">
        <Text>Workspaces: {workspaces.length}</Text>
        <Text>Default Agent: {settings.defaultAgent}</Text>
        <Text>IDE: {settings.ideCommand}</Text>
      </Box>

      {workspaces.length === 0 ? (
        <Box marginBottom={1}>
          <Text color="yellow">No workspaces yet. (Phase 2 will add workspace creation)</Text>
        </Box>
      ) : (
        <Box flexDirection="column" marginBottom={1}>
          {workspaces.map((ws) => (
            <Text key={ws.id}>
              - {ws.name} ({ws.branch}) [{ws.agent}]
            </Text>
          ))}
        </Box>
      )}

      <Box marginTop={1} flexDirection="column">
        <Text color="gray">s: settings | q: quit</Text>
      </Box>
    </Box>
  );
}

export function App() {
  return (
    <Provider>
      <AppContent />
    </Provider>
  );
}
```

Create entry point:

```typescript
// src/index.ts
import React from 'react';
import { render } from 'ink';
import { App } from './app.js';
import { setupGracefulShutdown } from './processes/lifecycle.js';
import { processRegistry } from './processes/cleanup.js';

// CRITICAL: Setup shutdown handlers BEFORE any rendering
// This ensures cleanup runs even if app crashes during startup
setupGracefulShutdown(async () => {
  console.log('[equipe] Saving state before exit...');
  // Additional cleanup can go here (e.g., force-save state)
});

console.log('[equipe] Starting...');

// Render Ink app
const app = render(React.createElement(App));

// Wait for exit
app.waitUntilExit().then(() => {
  console.log('[equipe] Exited cleanly');
}).catch((error) => {
  console.error('[equipe] Exit error:', error);
  process.exit(1);
});
```

Update package.json scripts:
```json
{
  "scripts": {
    "start": "node dist/index.js",
    "dev": "tsc --watch"
  }
}
```
  </action>
  <verify>
Run `npm run build` - should compile without errors.
Run `npm start` - app should launch and show main screen.
Press 's' - should show settings screen.
Press 'q' - app should exit cleanly.
  </verify>
  <done>
App component wraps content in Jotai Provider.
Main screen shows workspace count and settings.
Settings screen accessible via 's' key.
Entry point sets up shutdown handlers before render.
App exits cleanly on 'q' or Ctrl+C.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 1 foundation: TypeScript project, configuration system, state persistence, process lifecycle management, and Ink app shell with settings UI.
  </what-built>
  <how-to-verify>
1. Run `npm run build && npm start`
2. Verify app launches showing "equipe - Coding Agent Workspace Manager"
3. Note the current settings displayed (IDE, Default Agent)
4. Press 's' to open settings
5. Navigate to IDE Command field, press Enter, type "cursor", press Enter
6. Navigate to Default Agent, press Enter to toggle to "opencode"
7. Press 'q' to return to main screen
8. Verify main screen shows updated settings (IDE: cursor, Default Agent: opencode)
9. Press 'q' to quit
10. Run `npm start` again
11. Verify settings persisted (still shows cursor and opencode)
12. Press Ctrl+C to test signal handling - should exit cleanly with "[equipe] Exited cleanly"
13. Verify terminal is NOT corrupted (can type normally)
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npm start` launches app without errors
3. Settings screen allows editing IDE command and toggling agent
4. Settings persist across app restarts
5. Ctrl+C triggers graceful shutdown
6. Terminal remains usable after app exit
7. No zombie processes (check with `ps aux | grep node` after exit)
</verification>

<success_criteria>
Phase 1 complete when:
- User can configure IDE command in settings (CONF-01)
- User can configure default agent in settings (CONF-02)
- App persists workspace state across restarts (UI-04)
- App restores active workspaces on launch (UI-05)
- Terminal remains usable after app crashes
- All spawned processes clean up properly on exit
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
